name: Nightly Builds

on:
  schedule:
    # Run daily at 02:00 UTC (3 AM in Baghdad)
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write

jobs:
  check-changes:
    name: Check for New Commits
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.has_changes }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for changes since last nightly
        id: check
        run: |
          # Check if there are any commits in the last 24 hours
          COMMITS=$(git log --since="24 hours ago" --oneline | wc -l)

          if [ $COMMITS -gt 0 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Found $COMMITS new commits, proceeding with nightly build"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No new commits in the last 24 hours, skipping build"
          fi

  build:
    name: Nightly Build - ${{ matrix.platform }}
    needs: check-changes
    if: needs.check-changes.outputs.should_build == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            platform: mac
          - os: ubuntu-latest
            platform: linux
          - os: windows-latest
            platform: windows

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Get short SHA
        id: sha
        run: echo "short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        shell: bash

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm run test
        continue-on-error: true  # Tests have known configuration issues, don't fail nightly builds

      - name: Build application
        run: npm run build

      - name: Package nightly build
        run: npm run dist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate release directory
        id: validate
        run: |
          if [ ! -d "release" ]; then
            echo "âŒ Error: release directory not found"
            exit 1
          fi

          file_count=$(find release -type f | wc -l)
          if [ "$file_count" -eq 0 ]; then
            echo "âŒ Error: No artifacts found in release directory"
            exit 1
          fi

          echo "âœ… Found $file_count artifact(s) in release directory"
          echo "file_count=$file_count" >> $GITHUB_OUTPUT
        shell: bash

      - name: Rename artifacts with nightly prefix
        run: |
          cd release
          renamed_count=0

          for file in *; do
            # Skip if not a file or already has nightly prefix
            if [ ! -f "$file" ] || [[ "$file" == nightly-* ]]; then
              continue
            fi

            new_name="nightly-${{ steps.sha.outputs.short }}-$file"
            echo "Renaming: $file -> $new_name"
            mv "$file" "$new_name"
            renamed_count=$((renamed_count + 1))
          done

          echo "âœ… Renamed $renamed_count file(s)"

          if [ $renamed_count -eq 0 ]; then
            echo "âš ï¸ Warning: No files were renamed"
          fi
        shell: bash

      - name: List artifacts to upload
        run: |
          echo "ðŸ“¦ Artifacts to upload:"
          ls -lh release/nightly-* || echo "âš ï¸ No nightly artifacts found"
        shell: bash

      - name: Upload nightly artifacts (macOS)
        if: matrix.platform == 'mac'
        uses: actions/upload-artifact@v4
        with:
          name: nightly-macos-${{ steps.sha.outputs.short }}
          path: |
            release/nightly-*.dmg
            release/nightly-*.zip
          retention-days: 7
          if-no-files-found: error

      - name: Upload nightly artifacts (Linux)
        if: matrix.platform == 'linux'
        uses: actions/upload-artifact@v4
        with:
          name: nightly-linux-${{ steps.sha.outputs.short }}
          path: |
            release/nightly-*.AppImage
            release/nightly-*.deb
          retention-days: 7
          if-no-files-found: error

      - name: Upload nightly artifacts (Windows)
        if: matrix.platform == 'windows'
        uses: actions/upload-artifact@v4
        with:
          name: nightly-windows-${{ steps.sha.outputs.short }}
          path: release/nightly-*.exe
          retention-days: 7
          if-no-files-found: error

      - name: Generate build summary
        if: always()
        run: |
          echo "## ðŸŒ™ Nightly Build Summary - ${{ matrix.platform }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Platform:** ${{ matrix.platform }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ steps.sha.outputs.short }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -d "release" ]; then
            echo "### ðŸ“¦ Built Artifacts:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            ls -lh release/nightly-* 2>/dev/null || echo "No artifacts found"
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
        shell: bash

  notify:
    name: Notify Build Status
    needs: [check-changes, build]
    if: always() && (needs.check-changes.outputs.should_build == 'true' || github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest

    steps:
      - name: Check build status
        id: status
        run: |
          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "status=âœ… Success" >> $GITHUB_OUTPUT
            echo "color=success" >> $GITHUB_OUTPUT
          elif [ "${{ needs.build.result }}" == "failure" ]; then
            echo "status=âŒ Failed" >> $GITHUB_OUTPUT
            echo "color=danger" >> $GITHUB_OUTPUT
          else
            echo "status=âš ï¸ Partial" >> $GITHUB_OUTPUT
            echo "color=warning" >> $GITHUB_OUTPUT
          fi

      - name: Create issue on failure
        if: needs.build.result == 'failure'
        uses: actions/github-script@v8
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸŒ™ Nightly Build Failed - ${new Date().toISOString().split('T')[0]}`,
              body: `The nightly build failed. Please check the [workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId}) for details.`,
              labels: ['ci', 'nightly-build', 'automated']
            });

  cleanup:
    name: Cleanup Old Nightly Artifacts
    needs: build
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Delete old nightly artifacts
        uses: actions/github-script@v8
        with:
          script: |
            console.log('ðŸ§¹ Starting cleanup of old nightly artifacts...');

            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            // Filter and sort nightly artifacts by creation date (newest first)
            const nightlyArtifacts = artifacts.data.artifacts
              .filter(artifact => artifact.name.startsWith('nightly-'))
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            console.log(`Found ${nightlyArtifacts.length} nightly artifacts`);

            // Group artifacts by platform
            const platforms = ['macos', 'linux', 'windows'];
            const artifactsByPlatform = {};

            platforms.forEach(platform => {
              artifactsByPlatform[platform] = nightlyArtifacts.filter(artifact =>
                artifact.name.includes(platform)
              );
            });

            // Keep the 7 most recent artifacts per platform
            const keepCount = 7;
            const toDelete = [];

            for (const [platform, artifacts] of Object.entries(artifactsByPlatform)) {
              const keep = artifacts.slice(0, keepCount);
              const deleteList = artifacts.slice(keepCount);

              console.log(`${platform}: keeping ${keep.length}, deleting ${deleteList.length}`);
              toDelete.push(...deleteList);
            }

            // Delete old artifacts
            for (const artifact of toDelete) {
              console.log(`Deleting: ${artifact.name} (created: ${artifact.created_at})`);
              try {
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id
                });
              } catch (error) {
                console.error(`Failed to delete ${artifact.name}: ${error.message}`);
              }
            }

            console.log(`âœ… Cleanup complete. Deleted ${toDelete.length} old nightly artifacts`);
